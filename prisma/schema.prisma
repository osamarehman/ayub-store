// Prisma Schema for Bin Ayub General E-Commerce Store

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// AUTHENTICATION & USERS
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String
  image         String?
  role          UserRole  @default(CUSTOMER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts  Account[]
  sessions  Session[]
  orders    Order[]
  cart      Cart?
  addresses Address[]
  wishlist  Wishlist[]

  @@index([email])
}

enum UserRole {
  ADMIN
  CUSTOMER
}

// NextAuth.js Models
model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

// ============================================
// PRODUCTS & CATALOG
// ============================================

model Product {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String? @db.Text
  brand       String
  gender      Gender?

  // Pricing
  basePrice Decimal  @db.Decimal(10, 2)
  salePrice Decimal? @db.Decimal(10, 2)

  // Images
  mainImage String
  images    String[]

  // Status
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)

  // Tags for filtering and display
  tags String[] @default([])

  // SEO
  metaTitle       String?
  metaDescription String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  variants       ProductVariant[]
  categories     ProductCategory[]
  orderItems     OrderItem[]
  cartItems      CartItem[]
  wishlist       Wishlist[]
  reviews        Review[]

  @@index([slug])
  @@index([brand])
  @@index([isActive])
  @@index([isFeatured])
  @@index([tags])
}

enum Gender {
  MEN
  WOMEN
  UNISEX
}

model ProductVariant {
  id        String @id @default(cuid())
  productId String

  // Variant Details
  size  String // e.g., "50ml", "100ml"
  price Decimal @db.Decimal(10, 2)
  sku   String  @unique
  stock Int     @default(0)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([sku])
}

model Category {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String?
  image       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  products ProductCategory[]

  @@index([slug])
}

model ProductCategory {
  productId  String
  categoryId String

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
}

// ============================================
// SHOPPING CART
// ============================================

model Cart {
  id     String  @id @default(cuid())
  userId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user  User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@index([userId])
}

model CartItem {
  id        String  @id @default(cuid())
  cartId    String
  productId String
  variantId String?
  quantity  Int     @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([cartId])
  @@index([productId])
}

// ============================================
// WISHLIST
// ============================================

model Wishlist {
  id        String @id @default(cuid())
  userId    String
  productId String

  createdAt DateTime @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

// ============================================
// ORDERS & CHECKOUT
// ============================================

model Order {
  id          String @id @default(cuid())
  orderNumber String @unique

  // Customer Information
  userId        String?
  customerName  String
  customerEmail String
  customerPhone String

  // Shipping Information
  shippingName       String
  shippingEmail      String
  shippingPhone      String
  shippingAddress    String  @db.Text
  shippingCity       String
  shippingArea       String?
  shippingPostalCode String?

  // Order Details
  subtotal     Decimal @db.Decimal(10, 2)
  shippingCost Decimal @db.Decimal(10, 2)
  discount     Decimal @default(0) @db.Decimal(10, 2)
  tax          Decimal @default(0) @db.Decimal(10, 2)
  total        Decimal @db.Decimal(10, 2)

  // Status
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  paymentMethod PaymentMethod

  // Notes
  notes         String? @db.Text
  customerNotes String? @db.Text
  adminNotes    String? @db.Text

  // Promo Code
  promoCodeId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user      User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  items     OrderItem[]
  promoCode PromoCode?  @relation(fields: [promoCodeId], references: [id], onDelete: SetNull)

  @@index([orderNumber])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  COD
  WHATSAPP
}

model OrderItem {
  id        String @id @default(cuid())
  orderId   String
  productId String

  // Product Snapshot (at time of order)
  productName  String
  productSlug  String
  productBrand String
  productImage String

  // Variant Snapshot
  variantId   String
  variantSize String?
  variantSku  String

  // Pricing
  price    Decimal @db.Decimal(10, 2)
  quantity Int
  total    Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
}

// ============================================
// ADDRESSES
// ============================================

model Address {
  id     String @id @default(cuid())
  userId String

  fullName String
  phone    String
  address  String
  city     String
  area     String?
  zipCode  String?

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// PROMO CODES
// ============================================

model PromoCode {
  id          String  @id @default(cuid())
  code        String  @unique
  description String?

  // Discount
  discountType  DiscountType
  discountValue Decimal      @db.Decimal(10, 2)

  // Usage Limits
  maxUses       Int?
  usedCount     Int      @default(0)
  minOrderValue Decimal? @db.Decimal(10, 2)

  // Validity
  isActive   Boolean   @default(true)
  validFrom  DateTime
  validUntil DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders Order[]

  @@index([code])
  @@index([isActive])
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

// ============================================
// REVIEWS & RATINGS
// ============================================

model Review {
  id        String  @id @default(cuid())
  productId String
  userId    String?

  // Review Details
  name    String
  email   String?
  rating  Int // 1-5
  title   String?
  comment String  @db.Text

  // Status
  isApproved Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([isApproved])
}

// ============================================
// ASSETS / MEDIA LIBRARY
// ============================================

model Asset {
  id       String @id @default(cuid())

  // File info
  filename String
  path     String @unique  // The storage path/URL
  url      String          // Full accessible URL

  // Metadata (editable)
  name     String          // Display name
  altText  String?         // Alt text for accessibility

  // Technical info
  size      Int      @default(0)  // File size in bytes
  width     Int?                   // Image width
  height    Int?                   // Image height
  mimeType  String?               // e.g., image/jpeg

  // Organization
  category  String   @default("products")  // products, categories, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([name])
}
